<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>L·ªãch s·ª≠ Giao d·ªãch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .badge-NH·∫¨P { background-color: #198754; } /* Xanh l√° */
        .badge-XU·∫§T { background-color: #fd7e14; } /* Cam */
        .badge-X√ìA { background-color: #dc3545; }  /* ƒê·ªè */
        .filter-box { background-color: #e9ecef; border-radius: 8px; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="/admin/dashboard">
                <span class="me-2">‚¨Ö</span> Quay l·∫°i Dashboard
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">Hi, <%= user.username %></span>
                <a href="/admin/logout" class="btn btn-light btn-sm">Tho√°t</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        
        <div class="card shadow-sm mb-4">
            <div class="card-body filter-box">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold text-secondary">üîç L·ªçc theo M√£ SKU:</label>
                        <input type="text" id="filterSku" class="form-control" placeholder="Nh·∫≠p m√£ s·∫£n ph·∫©m..." onkeyup="filterTable()">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold text-secondary">üë§ L·ªçc theo Nh√¢n vi√™n:</label>
                        <input type="text" id="filterUser" class="form-control" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n..." onkeyup="filterTable()">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-secondary w-100" onclick="resetFilters()">X√≥a b·ªô l·ªçc</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-primary">üìú Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông </h5>
                <div>
                    <span class="badge bg-secondary me-2">Hi·ªÉn th·ªã 2000 d√≤ng m·ªõi nh·∫•t</span>
                    <span id="rowCount" class="badge bg-info text-dark"></span>
                </div>
            </div>
            <div class="card-body p-0">
                <form action="/admin/history/delete" method="POST" id="deleteForm" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√°c d√≤ng ƒë√£ ch·ªçn?');">
                    <div class="p-2 d-flex justify-content-end bg-light border-bottom">
                        <button type="submit" class="btn btn-danger btn-sm" id="deleteBtn" disabled>
                            üóë X√≥a m·ª•c ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 align-middle" id="historyTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                                    <th>Th·ªùi gian</th>
                                    <th>Ng∆∞·ªùi d√πng</th> <th>H√†nh ƒë·ªông</th>
                                    <th>M√£ SKU</th>     <th>S·ªë l∆∞·ª£ng</th>
                                    <th>T·ªìn sau GD</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% logs.forEach(function(log) { %>
                                    <tr>
                                        <td><input type="checkbox" name="logIds" value="<%= log.id %>" class="form-check-input log-checkbox"></td>
                                        <td style="white-space: nowrap;"><%= new Date(log.timestamp).toLocaleString('vi-VN') %></td>
                                        
                                        <td class="fw-bold text-secondary"><%= log.user %></td>
                                        
                                        <td>
                                            <% 
                                                let badgeClass = 'bg-secondary';
                                                if(log.action.includes('NH·∫¨P')) badgeClass = 'badge-NH·∫¨P';
                                                if(log.action.includes('XU·∫§T')) badgeClass = 'badge-XU·∫§T';
                                                if(log.action.includes('X√ìA')) badgeClass = 'badge-X√ìA';
                                            %>
                                            <span class="badge <%= badgeClass %>"><%= log.action %></span>
                                        </td>
                                        
                                        <td class="fw-bold text-primary"><%= log.sku %></td>
                                        
                                        <td class="<%= log.quantity > 0 ? 'text-success fw-bold' : '' %>">
                                            <%= log.quantity %>
                                        </td>
                                        
                                        <td><%= log.balance %></td>
                                    </tr>
                                <% }); %>
                                
                                <% if (logs.length === 0) { %>
                                    <tr class="no-data"><td colspan="7" class="text-center py-4 text-muted">Ch∆∞a c√≥ l·ªãch s·ª≠ n√†o.</td></tr>
                                <% } %>
                                
                                <tr id="noResultRow" style="display: none;">
                                    <td colspan="7" class="text-center py-4 text-danger fw-bold">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 1. K·∫øt n·ªëi Socket.io ƒë·ªÉ t·ª± ƒë·ªông reload khi c√≥ d·ªØ li·ªáu m·ªõi
        const socket = io();
        socket.on('data_updated', () => {
            // L∆∞u l·∫°i t·ª´ kh√≥a ƒëang t√¨m ki·∫øm tr∆∞·ªõc khi reload
            sessionStorage.setItem('searchSku', document.getElementById('filterSku').value);
            sessionStorage.setItem('searchUser', document.getElementById('filterUser').value);
            location.reload(); 
        });

        // Kh√¥i ph·ª•c b·ªô l·ªçc sau khi reload trang
        window.onload = function() {
            const savedSku = sessionStorage.getItem('searchSku');
            const savedUser = sessionStorage.getItem('searchUser');
            if(savedSku) document.getElementById('filterSku').value = savedSku;
            if(savedUser) document.getElementById('filterUser').value = savedUser;
            filterTable(); // Ch·∫°y l·∫°i b·ªô l·ªçc
        };

        // 2. H√†m L·ªçc B·∫£ng (Ch·∫°y ngay tr√™n tr√¨nh duy·ªát, si√™u nhanh)
        function filterTable() {
            // L·∫•y gi√° tr·ªã t·ª´ √¥ nh·∫≠p li·ªáu, chuy·ªÉn v·ªÅ ch·ªØ th∆∞·ªùng
            var inputSku = document.getElementById("filterSku").value.toLowerCase();
            var inputUser = document.getElementById("filterUser").value.toLowerCase();
            
            var table = document.getElementById("historyTable");
            var tr = table.getElementsByTagName("tr");
            var visibleCount = 0;
            var hasData = false;

            // Duy·ªát qua t·ª´ng d√≤ng (b·ªè qua d√≤ng ti√™u ƒë·ªÅ index 0)
            for (var i = 1; i < tr.length; i++) {
                // B·ªè qua d√≤ng th√¥ng b√°o "Kh√¥ng t√¨m th·∫•y" ho·∫∑c "Ch∆∞a c√≥ d·ªØ li·ªáu"
                if (tr[i].id === "noResultRow" || tr[i].classList.contains("no-data")) continue;

                // C·ªôt Ng∆∞·ªùi d√πng l√† c·ªôt th·ª© 2 (index 1), C·ªôt SKU l√† c·ªôt th·ª© 4 (index 3)
                var tdUser = tr[i].getElementsByTagName("td")[1];
                var tdSku = tr[i].getElementsByTagName("td")[3];

                if (tdUser && tdSku) {
                    var txtUser = tdUser.textContent || tdUser.innerText;
                    var txtSku = tdSku.textContent || tdSku.innerText;

                    // Ki·ªÉm tra xem c√≥ ch·ª©a t·ª´ kh√≥a kh√¥ng
                    if (txtUser.toLowerCase().indexOf(inputUser) > -1 && 
                        txtSku.toLowerCase().indexOf(inputSku) > -1) {
                        tr[i].style.display = ""; // Hi·ªán
                        visibleCount++;
                        hasData = true;
                    } else {
                        tr[i].style.display = "none"; // ·∫®n
                    }
                }
            }

            // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng k·∫øt qu·∫£
            document.getElementById("rowCount").innerText = "K·∫øt qu·∫£: " + visibleCount;

            // Hi·ªÉn th·ªã d√≤ng th√¥ng b√°o n·∫øu kh√¥ng c√≥ k·∫øt qu·∫£ n√†o
            document.getElementById("noResultRow").style.display = hasData ? "none" : "";
        }

        // 3. H√†m X√≥a b·ªô l·ªçc
        function resetFilters() {
            document.getElementById("filterSku").value = "";
            document.getElementById("filterUser").value = "";
            sessionStorage.removeItem('searchSku');
            sessionStorage.removeItem('searchUser');
            sessionStorage.removeItem('searchUser');
            filterTable();
        }

        // 4. X·ª≠ l√Ω Checkbox ch·ªçn nhi·ªÅu
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.log-checkbox');
        const deleteBtn = document.getElementById('deleteBtn');
        const selectedCountSpan = document.getElementById('selectedCount');

        function updateDeleteButton() {
            const checkedCount = document.querySelectorAll('.log-checkbox:checked').length;
            selectedCountSpan.innerText = checkedCount;
            deleteBtn.disabled = checkedCount === 0;
        }

        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => {
                // Ch·ªâ ch·ªçn nh·ªØng d√≤ng ƒëang hi·ªÉn th·ªã (kh√¥ng b·ªã ·∫©n b·ªüi b·ªô l·ªçc)
                if (cb.closest('tr').style.display !== 'none') {
                    cb.checked = this.checked;
                }
            });
            updateDeleteButton();
        });

        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateDeleteButton);
        });

        // C·∫≠p nh·∫≠t l·∫°i khi l·ªçc (b·ªè ch·ªçn nh·ªØng d√≤ng b·ªã ·∫©n ƒëi cho an to√†n, ho·∫∑c gi·ªØ nguy√™n t√πy logic)
        // ·ªû ƒë√¢y ta gi·ªØ nguy√™n logic ƒë∆°n gi·∫£n: checkbox ho·∫°t ƒë·ªông ƒë·ªôc l·∫≠p v·ªõi filter, 
        // nh∆∞ng khi b·∫•m Select All th√¨ ch·ªâ ch·ªçn row ƒëang hi·ªán.

    </script>
</body>
</html>
